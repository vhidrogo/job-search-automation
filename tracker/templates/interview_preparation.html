<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Prep - {{ job.company }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .header .meta {
            color: #666;
            font-size: 14px;
        }
        .interview-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .interview-selector label {
            font-weight: 600;
            margin-right: 10px;
        }
        .interview-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        .section {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .section-summary {
            cursor: pointer;
            user-select: none;
            list-style: none;
        }
        .section-summary::-webkit-details-marker {
            display: none;
        }
        .section-summary h2 {
            margin: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding: 20px 25px 10px 25px;
        }
        .section-summary h2::after {
            content: "▾";
            float: right;
        }
        .section[open] .section-summary h2::after {
            content: "▴";
        }
        .section > .markdown-content {
            padding: 15px 25px 25px 25px;
        }
        .section h3 {
            color: #555;
            margin: 20px 0 10px 0;
        }
        .section h4 {
            color: #666;
            margin: 15px 0 8px 0;
        }
        .markdown-content {
            color: #333;
        }
        .markdown-content p {
            margin: 10px 0;
        }
        .markdown-content ul, .markdown-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        .markdown-content li {
            margin: 5px 0;
        }
        .markdown-content strong {
            color: #000;
            font-weight: 600;
        }
        .markdown-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .markdown-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .markdown-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 20px 0;
        }
        /* Tables rendered from markdown */
        .markdown-content table {
          width: 100%;
          border-collapse: collapse;
        }
        .markdown-content th,
        .markdown-content td {
          padding: 10px 12px;
          vertical-align: top;
        }
        /* header line */
        .markdown-content thead th {
          border-bottom: 1px solid #ddd;
        }
        /* row separators */
        .markdown-content tbody tr {
          border-bottom: 1px solid #e6e6e6;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .layout {
            display: block;
        }
        .side-nav {
            position: fixed;
            top: 20px;
            /* Put the nav in the left gutter next to the centered 1000px column */
            left: max(20px, calc((100vw - 1000px) / 2 - 300px));
            width: 240px;
            align-self: start;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: calc(100vh - 40px);
            overflow: auto;
            z-index: 1000;
        }
        .side-nav__title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .side-nav__link {
            display: block;
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 6px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
        }
        .side-nav__link:hover {
            background: #f4f4f4;
        }
        .side-nav__link.is-active {
            background: #e9f2ff;
            color: #0b57d0;
            font-weight: 600;
        }
        .main-content {
            min-width: 0;
        }

        /* On smaller screens, revert to top nav so it doesn't cover content */
        @media (max-width: 1299px) {
            .side-nav {
                position: static;
                width: auto;
                max-height: none;
                z-index: auto;
                left: auto;
            }
        }

        @media print {
            .side-nav {
                display: none;
            }
            .layout {
                display: block;
            }
            body {
                background: white;
            }
            .section {
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            .section-summary h2::after {
                content: "";
            }
            .section:not([open]) > .markdown-content {
                display: block;
            }
            .interview-selector {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Interview Preparation</h1>
        <div class="meta">
            <strong>{{ job.listing_job_title }}</strong> at <strong>{{ job.company }}</strong><br>
            {{ job.location }} • {{ job.work_setting }}
        </div>
    </div>

    <div class="interview-selector">
        <label for="interview-select">Interview Stage:</label>
        <select id="interview-select" onchange="changeInterview()">
            {% for interview in interviews %}
            <option value="{{ interview.id }}" {% if interview.id == selected_interview.id %}selected{% endif %}>
                {{ interview.get_stage_display }}
                {% if interview.scheduled_at %}
                    - {{ interview.scheduled_at|date:"M d, Y" }}
                {% endif %}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="layout">
        <nav class="side-nav" aria-label="Section navigation">
            <div class="side-nav__title">Sections</div>
            <a class="side-nav__link" href="#job-description">Job Description</a>
            <a class="side-nav__link" href="#company-context-section">Company &amp; Product Context</a>
            <a class="side-nav__link" href="#primary-drivers-section">Primary Callback Drivers</a>
            <a class="side-nav__link" href="#background-narrative-section">Targeted Background Narrative</a>
            <a class="side-nav__link" href="#resume-defense-section">Resume Defense Preparation</a>
            {% if interview_prep %}
            <a class="side-nav__link" href="#prep-roadmap-section">Preparation Roadmap</a>
            <a class="side-nav__link" href="#predicted-questions-section">Predicted Interview Questions &amp; Responses</a>
            <a class="side-nav__link" href="#interviewer-questions-section">Interviewer-Aligned Questions</a>
            <a class="side-nav__link" href="#technical-deep-dives-section">Technical Deep Dives</a>
            {% endif %}
        </nav>

        <main class="main-content">
            <!-- Base Preparation Sections -->
            <details class="section" id="job-description" open>
              <summary class="section-summary">
                <h2>Job Description</h2>
              </summary>
              <div class="markdown-content" id="formatted-jd"></div>
            </details>

            <details class="section" id="company-context-section" open>
              <summary class="section-summary">
                <h2>Company &amp; Product Context</h2>
              </summary>
              <div class="markdown-content" id="company-context"></div>
            </details>

            <details class="section" id="primary-drivers-section" open>
              <summary class="section-summary">
                <h2>Primary Callback Drivers</h2>
              </summary>
              <div class="markdown-content" id="primary-drivers"></div>
            </details>

            <details class="section" id="background-narrative-section" open>
              <summary class="section-summary">
                <h2>Targeted Background Narrative</h2>
              </summary>
              <div class="markdown-content" id="background-narrative"></div>
            </details>

            <details class="section" id="resume-defense-section" open>
              <summary class="section-summary">
                <h2>Resume Defense Preparation</h2>
              </summary>
              <div class="markdown-content" id="resume-defense-prep"></div>
            </details>

            <!-- Interview-Specific Sections -->
            {% if interview_prep %}
            <details class="section" id="prep-roadmap-section" open>
              <summary class="section-summary">
                <h2>Preparation Roadmap</h2>
              </summary>
              <div class="markdown-content" id="prep-plan"></div>
            </details>

            <details class="section" id="predicted-questions-section" open>
              <summary class="section-summary">
                <h2>Predicted Interview Questions &amp; Responses</h2>
              </summary>
              <div class="markdown-content" id="predicted-questions"></div>
            </details>

            <details class="section" id="interviewer-questions-section" open>
              <summary class="section-summary">
                <h2>Interviewer-Aligned Questions</h2>
              </summary>
              <div class="markdown-content" id="interviewer-questions"></div>
            </details>

            <details class="section" id="technical-deep-dives-section" open>
              <summary class="section-summary">
                <h2>Technical Deep Dives</h2>
              </summary>
              <div class="markdown-content" id="technical-deep-dives"></div>
            </details>
            {% else %}
            <div class="warning">
              <strong>Note:</strong> Interview-specific preparation has not been generated for this interview yet.
              Run the generation command to create it.
            </div>
            {% endif %}
        </main>
    </div>

    <script>
        // Render markdown content
        function renderMarkdown() {
            const sections = [
                { id: 'formatted-jd', content: "{{ prep_base.formatted_jd|escapejs }}" },
                { id: 'company-context', content: "{{ prep_base.company_context|escapejs }}" },
                { id: 'primary-drivers', content: "{{ prep_base.primary_drivers|escapejs }}" },
                { id: 'background-narrative', content: "{{ prep_base.background_narrative|escapejs }}" },
                { id: 'resume-defense-prep', content: "{{ prep_base.resume_defense_prep|escapejs }}" },
                {% if interview_prep %}
                { id: 'prep-plan', content: "{{ interview_prep.prep_plan|escapejs }}" },
                { id: 'predicted-questions', content: "{{ interview_prep.predicted_questions|escapejs }}" },
                { id: 'interviewer-questions', content: "{{ interview_prep.interviewer_questions|escapejs }}" },
                { id: 'technical-deep-dives', content: "{{ interview_prep.technical_deep_dives|escapejs }}" },
                {% endif %}
            ];

            sections.forEach(section => {
                const element = document.getElementById(section.id);
                if (element && section.content) {
                    element.innerHTML = marked.parse(section.content);
                }
            });

            // Apply syntax highlighting to all code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function changeInterview() {
            const select = document.getElementById('interview-select');
            const interviewId = select.value;
            const url = new URL(window.location);
            url.searchParams.set('interview_id', interviewId);
            window.location = url;
        }

        function openSectionFromHash() {
            if (!window.location.hash) return;
            const id = window.location.hash.slice(1);

            setActiveNavById(id);

            const target = document.getElementById(id);
            if (target && target.tagName.toLowerCase() === 'details') {
                target.open = true;
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function setActiveNavById(id) {
            document.querySelectorAll('.side-nav__link').forEach(a => a.classList.remove('is-active'));
            const link = document.querySelector(`.side-nav__link[href="#${CSS.escape(id)}"]`);
            if (link) link.classList.add('is-active');
        }

        function wireNavClicks() {
            document.querySelectorAll('.side-nav__link').forEach(link => {
                link.addEventListener('click', () => {
                    const href = link.getAttribute('href');
                    if (!href || !href.startsWith('#')) return;

                    const id = href.slice(1);
                    const target = document.getElementById(id);

                    if (target && target.tagName.toLowerCase() === 'details') {
                        target.open = true;
                    }

                    // Immediately update highlight (don’t rely on IntersectionObserver)
                    setActiveNavById(id);
                });
            });
        }

        function setupActiveSectionHighlight() {
            const links = Array.from(document.querySelectorAll('.side-nav__link'));
            const ids = links
                .map(a => a.getAttribute('href'))
                .filter(h => h && h.startsWith('#'))
                .map(h => h.slice(1));

            const sections = ids
                .map(id => document.getElementById(id))
                .filter(el => el && el.tagName.toLowerCase() === 'details');

            if (!sections.length) return;

            // Pick a point slightly below the top so headers aren’t too “twitchy”
            const ACTIVE_Y = 120;

            let ticking = false;

            function updateActive() {
                ticking = false;

                let best = null;

                for (const s of sections) {
                    const r = s.getBoundingClientRect();

                    // Active if the ACTIVE_Y line is inside the section bounds
                    if (r.top <= ACTIVE_Y && r.bottom > ACTIVE_Y) {
                        best = s;
                        break; // sections are in DOM order, first match is correct
                    }
                }

                // Fallback: if nothing contains ACTIVE_Y (e.g., very top), pick first visible
                if (!best) {
                    best = sections.find(s => s.getBoundingClientRect().bottom > 0) || sections[0];
                }

                if (best) setActiveNavById(best.id);
            }

            function onScrollOrResize() {
                if (ticking) return;
                ticking = true;
                requestAnimationFrame(updateActive);
            }

            window.addEventListener('scroll', onScrollOrResize, { passive: true });
            window.addEventListener('resize', onScrollOrResize);

            // Initial state
            updateActive();
        }
        // After markdown render (sections exist), wire everything up
        window.addEventListener('hashchange', openSectionFromHash);

        // Render on page load
        renderMarkdown();
        wireNavClicks();
        setupActiveSectionHighlight();
        openSectionFromHash();
    </script>
</body>
</html>